name: E2E Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for git blame

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and build action
        working-directory: action
        run: |
          npm install
          npm run build

      - name: Run E2E Test (Japanese) - Send to Slack
        id: e2e_ja
        uses: ./action
        with:
          slack_webhook_url: ${{ secrets.TEST_SLACK_WEBHOOK_URL }}
          language: 'ja'
          scan_directory: 'test_fixtures'
          notify_past_deadlines: true
          default_branch: 'main'

      - name: Run E2E Test (English) - Send to Slack
        id: e2e_en
        uses: ./action
        with:
          slack_webhook_url: ${{ secrets.TEST_SLACK_WEBHOOK_URL }}
          language: 'en'
          scan_directory: 'test_fixtures'
          notify_past_deadlines: true
          default_branch: 'main'

      - name: Display Results
        run: |
          echo "=============================================="
          echo "ðŸ“Š E2E Test Results"
          echo "=============================================="
          echo ""
          echo "Total annotations found: ${{ steps.e2e_ja.outputs.total_annotations }}"
          echo "Filtered annotations (matching criteria): ${{ steps.e2e_ja.outputs.filtered_annotations }}"
          echo ""
          echo "=============================================="
          echo "ðŸ“‹ Annotations JSON:"
          echo "=============================================="
          echo '${{ steps.e2e_ja.outputs.annotations_json }}' | jq '.' || echo '${{ steps.e2e_ja.outputs.annotations_json }}'

      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "âœ… E2E Test Complete"
          echo "=============================================="
          echo ""
          echo "The action successfully:"
          echo "  1. Scanned test_fixtures/ directory"
          echo "  2. Found ${{ steps.e2e_ja.outputs.total_annotations }} @Deadline annotations"
          echo "  3. Filtered to ${{ steps.e2e_ja.outputs.filtered_annotations }} annotations matching criteria"
          echo "  4. Sent Slack notification (Japanese)"
          echo "  5. Sent Slack notification (English)"
          echo ""
          echo "Check your Slack channel for the notifications!"
