name: E2E Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for git blame

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and build action
        working-directory: action
        run: |
          npm install
          npm run build

      - name: Run E2E Test (Japanese)
        id: e2e_ja
        uses: ./action
        with:
          language: 'ja'
          scan_directory: 'test_fixtures'
          notify_past_deadlines: true
          default_branch: 'main'
          # No slack_webhook_url - will output results without sending

      - name: Run E2E Test (English)
        id: e2e_en
        uses: ./action
        with:
          language: 'en'
          scan_directory: 'test_fixtures'
          notify_past_deadlines: true
          default_branch: 'main'

      - name: Display Results
        run: |
          echo "=============================================="
          echo "ğŸ“Š E2E Test Results"
          echo "=============================================="
          echo ""
          echo "Total annotations found: ${{ steps.e2e_ja.outputs.total_annotations }}"
          echo "Filtered annotations (matching criteria): ${{ steps.e2e_ja.outputs.filtered_annotations }}"
          echo ""
          echo "=============================================="
          echo "ğŸ“‹ Annotations JSON:"
          echo "=============================================="
          echo '${{ steps.e2e_ja.outputs.annotations_json }}' | jq '.' || echo '${{ steps.e2e_ja.outputs.annotations_json }}'

      - name: Generate Slack Preview (Japanese)
        run: |
          echo ""
          echo "=============================================="
          echo "ğŸ‡¯ğŸ‡µ Slack Preview (Japanese)"
          echo "=============================================="
          echo ""

          cat << 'PREVIEW'
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  âš ï¸ ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³é€šçŸ¥                                            â”‚
          â”‚  12 ä»¶ã®ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ                              â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                â”‚
          â”‚  ğŸš¨ ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’éãã¦ã„ã¾ã™ (ç´„1å¹´è¶…é) @tech-debt            â”‚
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚  å¯¾è±¡: veryOldDeadline                                         â”‚
          â”‚  ãƒ•ã‚¡ã‚¤ãƒ«: test_fixtures/sample_deadlines.dart (è¡Œ: 148)        â”‚
          â”‚  ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³: 2024-01-01                                       â”‚
          â”‚  èª¬æ˜: This has been overdue for a year!                       â”‚
          â”‚                                                                â”‚
          â”‚  ```dart                                                       â”‚
          â”‚  void veryOldDeadline() {                                      â”‚
          â”‚    // This should have been removed long ago                   â”‚
          â”‚  }                                                             â”‚
          â”‚  ```                                                           â”‚
          â”‚                                                    [ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹] â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                â”‚
          â”‚  ğŸš¨ ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’éãã¦ã„ã¾ã™ @channel                          â”‚
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚  å¯¾è±¡: LegacyAuthService                                       â”‚
          â”‚  ãƒ•ã‚¡ã‚¤ãƒ«: test_fixtures/sample_deadlines.dart (è¡Œ: 10)         â”‚
          â”‚  ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³: 2025-01-01                                       â”‚
          â”‚  èª¬æ˜: New Year cleanup - remove legacy authentication         â”‚
          â”‚                                                                â”‚
          â”‚  ```dart                                                       â”‚
          â”‚  class LegacyAuthService {                                     â”‚
          â”‚    Future<bool> authenticate(String username, ...) async {    â”‚
          â”‚      // Old authentication logic                               â”‚
          â”‚      return false;                                             â”‚
          â”‚    }                                                           â”‚
          â”‚  }                                                             â”‚
          â”‚  ```                                                           â”‚
          â”‚                                                    [ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹] â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                â”‚
          â”‚  â° ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã«é”ã—ã¾ã—ãŸ                                     â”‚
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚  å¯¾è±¡: debugLogger                                             â”‚
          â”‚  ãƒ•ã‚¡ã‚¤ãƒ«: test_fixtures/sample_deadlines.dart (è¡Œ: 27)         â”‚
          â”‚  ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³: 2025-12-09                                       â”‚
          â”‚  èª¬æ˜: Remove temporary logging after debugging                â”‚
          â”‚                                                                â”‚
          â”‚  ```dart                                                       â”‚
          â”‚  void debugLogger(String message) {                            â”‚
          â”‚    print('[DEBUG] $message');                                  â”‚
          â”‚  }                                                             â”‚
          â”‚  ```                                                           â”‚
          â”‚                                                    [ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹] â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  ... (ä»–ã®ãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚‚åŒæ§˜ã«è¡¨ç¤º)                              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          PREVIEW

      - name: Generate Slack Preview (English)
        run: |
          echo ""
          echo "=============================================="
          echo "ğŸ‡ºğŸ‡¸ Slack Preview (English)"
          echo "=============================================="
          echo ""

          cat << 'PREVIEW'
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  âš ï¸ Deadline Reminder                                          â”‚
          â”‚  12 deadline(s) found                                          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                â”‚
          â”‚  ğŸš¨ Deadline passed (~1 year overdue) @tech-debt               â”‚
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚  Element: veryOldDeadline                                      â”‚
          â”‚  File: test_fixtures/sample_deadlines.dart (Line: 148)         â”‚
          â”‚  Deadline: 2024-01-01                                          â”‚
          â”‚  Description: This has been overdue for a year!                â”‚
          â”‚                                                                â”‚
          â”‚  ```dart                                                       â”‚
          â”‚  void veryOldDeadline() {                                      â”‚
          â”‚    // This should have been removed long ago                   â”‚
          â”‚  }                                                             â”‚
          â”‚  ```                                                           â”‚
          â”‚                                                     [View Code] â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                â”‚
          â”‚  ğŸš¨ Deadline passed @channel                                   â”‚
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚  Element: LegacyAuthService                                    â”‚
          â”‚  File: test_fixtures/sample_deadlines.dart (Line: 10)          â”‚
          â”‚  Deadline: 2025-01-01                                          â”‚
          â”‚  Description: New Year cleanup - remove legacy authentication  â”‚
          â”‚                                                                â”‚
          â”‚  ```dart                                                       â”‚
          â”‚  class LegacyAuthService {                                     â”‚
          â”‚    Future<bool> authenticate(String username, ...) async {    â”‚
          â”‚      // Old authentication logic                               â”‚
          â”‚      return false;                                             â”‚
          â”‚    }                                                           â”‚
          â”‚  }                                                             â”‚
          â”‚  ```                                                           â”‚
          â”‚                                                     [View Code] â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                                â”‚
          â”‚  â° Deadline reached                                            â”‚
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚  Element: debugLogger                                          â”‚
          â”‚  File: test_fixtures/sample_deadlines.dart (Line: 27)          â”‚
          â”‚  Deadline: 2025-12-09                                          â”‚
          â”‚  Description: Remove temporary logging after debugging         â”‚
          â”‚                                                                â”‚
          â”‚  ```dart                                                       â”‚
          â”‚  void debugLogger(String message) {                            â”‚
          â”‚    print('[DEBUG] $message');                                  â”‚
          â”‚  }                                                             â”‚
          â”‚  ```                                                           â”‚
          â”‚                                                     [View Code] â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  ... (more deadlines displayed similarly)                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          PREVIEW

      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "âœ… E2E Test Complete"
          echo "=============================================="
          echo ""
          echo "The action successfully:"
          echo "  1. Scanned test_fixtures/ directory"
          echo "  2. Found ${{ steps.e2e_ja.outputs.total_annotations }} @Deadline annotations"
          echo "  3. Filtered to ${{ steps.e2e_ja.outputs.filtered_annotations }} annotations matching criteria"
          echo "  4. Would send Slack notification (skipped - no webhook configured)"
          echo ""
          echo "To test with actual Slack notifications:"
          echo "  1. Add SLACK_WEBHOOK_URL to repository secrets"
          echo "  2. Add 'slack_webhook_url: \${{ secrets.SLACK_WEBHOOK_URL }}' to the action inputs"
